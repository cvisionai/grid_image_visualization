<!-- HTML -->
<script src="https://d3js.org/d3.v5.min.js"></script>
<!-- HTML -->
<link href="https://fonts.googleapis.com/css?family=Trirong:100,200" rel="stylesheet">
<!-- HTML -->
<body></body>
<!-- HTML -->
<div id="filters">
    Order by: 
      <a id="fish" >Fish</a> |
      <a id="crab" >Crab</a> |
      <a id="ray" >Ray</a> |
      <a id="update_data" >Update</a> |
  </div>
<style>
body {
    background-color: #323232;
    font-family: 'Trirong', georgia, times, serif;
    font-weight: 200;
    font-size: 18px;
}

body, a {
    color: #808080;
}

.grid {
   display: grid;
   grid-gap: 10px;
   grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
   grid-auto-rows: 120px;
   grid-auto-flow: dense;
}

.char {
   border-radius: 3px;
   padding: 0.5em;
   background-color: #808080;
   background-repeat: no-repeat;
   background-position: center;
   background-size: cover;
   position: relative;
}

.charContent {
   text-align: center;
   position: absolute;
   left: 0;
   right: 0;
   bottom: 0;
   margin: auto;
}

.char h2 { 
   display: inline-block;
   background-color:rgba(28,28,28,1); 
   font-size: 60%;
   line-height: auto;
   color:rgba(210,210,210,1); 
   padding: 3px 8px 3px 8px;
}

.open {
   grid-column-end: span 5;
   grid-row-end: span 4;
}
</style>

<script>
//Load in character data
d3.json("http://localhost:9000/images.json").then(function(data){
    createVis(data);
});

d3
   .select("#update_data")
   .on("click", function () {
        updateData();
   })
;

function updateData() {
    d3.json("http://localhost:9000/images3.json").then(function(data){
            createVis(data);
    });
}

var grid = d3.select("body")
    .append("div")
    .attr("id", "grid")
    .attr("class", "grid")
  ;
  
function createVis(my_data) {
  chars = grid
    .selectAll("div")
    .data(my_data.images, function(d) {return d.imgurl})
    .join(
      enter => {enter
        .append("div")
        .attr("class", "char")
        .style("background-image", function(d){
          return 'url("'+d.imgurl+'?raw=true")';
          })
        .append("div")
        .attr("class", "charContent")
        .append("h2")
        .text(function(d,i){
          return d.imgclass;
        })
        ;
        char_click = enter
          .selectAll(".char")
          .on("click", function(d, i) {
            if(this.className.split(' ').indexOf('open') > -1 ){
              d3.select(this).classed("open", false);
            }else{
              gridColumns = window.getComputedStyle(this.parentElement).gridTemplateColumns.split(" ");
              gridRows = window.getComputedStyle(this.parentElement).gridTemplateRows.split(" ");
              numColumns = gridColumns.length;
              numRows = gridRows.length;
              xPosInGrid = this.getBoundingClientRect().left - this.parentElement.getBoundingClientRect().left;
              yPosInGrid = this.getBoundingClientRect().top - this.parentElement.getBoundingClientRect().top;
              gridRowHeight = parseFloat(gridRows[0]) + parseFloat(window.getComputedStyle(this.parentElement).gridRowGap);
              gridColumnWidth = parseFloat(gridColumns[0]) + parseFloat(window.getComputedStyle(this.parentElement).gridColumnGap);
              thisRow = Math.round(yPosInGrid/gridRowHeight) +1;
              thisColumn = Math.round(xPosInGrid/gridColumnWidth) +1;
              thisPortrait = this.getElementsByClassName("portrait")[0];
              if(thisPortrait)thisPortrait.setAttribute("src",thisPortrait.getAttribute("data-src"));
              d3.selectAll(".char").classed("open", false);
              d3.selectAll(".char").style("grid-row-start", "auto");
              d3.selectAll(".char").style("grid-column-start", "auto");
              d3.select(this).classed("open", true);
              divWidth = parseFloat(window.getComputedStyle(this).gridColumnEnd.split(" ")[1]);
              divHeight = parseFloat(window.getComputedStyle(this).gridRowEnd.split(" ")[1]);
              if(thisRow+divHeight>numRows)thisRow = 1 + numRows-divHeight;
              if(thisColumn+divWidth>numColumns)thisColumn = 1 + numColumns-divWidth;
              d3.select(this).style("grid-row-start", thisRow)
              d3.select(this).style("grid-column-start", thisColumn)
            }
          });  
      },
      update => {
        update.select(".charContent").remove();
        update.append("div")
        .attr("class", "charContent")
        .append("h2")
        .text(function(d,i){
          return d.imgclass;
        })
      },
      exit => exit.remove());
}

  d3
   .select("#fish")
   .on("click", function () {
      d3.selectAll(".char").sort(function(a, b) {
        let count = 0;
        if(a['imgclass'] == 'fish' && b['imgclass'] != 'fish'){
            console.log("greater than");
            count=-1;
        };
        if(b['imgclass'] == 'fish' && a['imgclass'] != 'fish'){
            console.log("less than");
            count=1;
        };   
        return count;
      });
      d3.selectAll(".char").classed("open", false);
      d3.selectAll(".char").style("grid-row-start", "auto");
      d3.selectAll(".char").style("grid-column-start", "auto");
    })
;
  d3
   .select("#crab")
   .on("click", function () {
      d3.select(".open").select("h2").text("crab");
   })
;
  d3
   .select("#ray")
   .on("click", function () {
      d3.select(".open").select("h2").text("ray");
   })
;
</script>